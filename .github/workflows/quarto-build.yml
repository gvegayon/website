name: Build and Deploy Quarto Website

on:
  schedule:
    # Run every Sunday at 2 AM UTC (weekly update)
    - cron: '0 2 * * 0'
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    container:
      image: rocker/tidyverse:4.5.1
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get quarto 1.9.9
      run: |
        URL="https://github.com/quarto-dev/quarto-cli/releases/download/v1.9.9/quarto-1.9.9-linux-amd64.deb"
        wget "$URL" -O quarto.deb && dpkg -i quarto.deb
      shell: bash

    - name: Render Quarto website
      run: |
        make

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        git config --global --add safe.directory /__w/website/website

    - name: Deploy to GitHub Pages
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      run: |
        # Check if there are any changes in public directory
        if [ -d "public" ]; then
          git add public/
          if ! git diff --staged --quiet; then
            git commit -m "Update website - $(date)"
            git push
          else
            echo "No changes to commit"
          fi
        else
          echo "Public directory not found"
          exit 1
        fi

    - name: Upload site as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: built-site
        path: public/
        retention-days: 7

  post-artifact:
    needs: build-deploy
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Post artifact comment on PR
      uses: CDCgov/cfa-actions/post-artifact@main
      with:
        artifact-name: built-site
        gh-token: ${{ secrets.GITHUB_TOKEN }}
